<%= stylesheet_link_tag 'agile_board', plugin: 'redmine_sprint_board_pro' %>
<%= stylesheet_link_tag 'tags', plugin: 'redmine_sprint_board_pro' %>

<% content_for :header_tags do %>
  <meta name="csrf-token" content="<%= form_authenticity_token %>">
  <script>window.projectIdentifier = "<%= @project.identifier %>"</script>
<% end %>

<div class="sprint-breadcrumb">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <%= link_to @project.name, project_path(@project) %>
      </li>
      <li class="breadcrumb-item">
        <%= link_to 'Sprints', project_sprints_path(@project) %>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        <strong><%= @sprint.name %></strong>
      </li>
    </ol>
  </nav>
  <div class="sprint-header-info">
    <h1 class="sprint-title"><%= @sprint.name %></h1>
    <div class="sprint-status-badges">
      <span class="badge badge-<%= @sprint.completed? ? 'success' : 'primary' %>">
        <%= @sprint.completed? ? 'Completed' : 'Active' %>
      </span>
      <% if @sprint.start_date && @sprint.end_date %>
        <span class="badge badge-secondary">
          <%= distance_of_time_in_words(@sprint.start_date, @sprint.end_date) %> sprint
        </span>
      <% end %>
    </div>
  </div>
</div>

<div class="sprint-summary box">
  <div class="sprint-info-section">
    <div class="sprint-details">
      <p><strong>ðŸ“… Start Date:</strong> <%= format_date(@sprint.start_date) %></p>
      <p><strong>ðŸ“… End Date:</strong> <%= format_date(@sprint.end_date) %></p>
      <p><strong>ðŸ“ˆ Total Story Points:</strong> <%= @sprint.total_points %></p>
      <p><strong>âœ… Completed Points:</strong> <%= @sprint.completed_points %></p>
      <p><strong>ðŸ“Š Progress:</strong> <%= sprint_progress_percent(@sprint) %>%</p>
      <p><%= link_to 'ðŸ“Š Dashboard', dashboard_project_sprint_path(@project,@sprint) %></p>
    </div>

    <%= render 'shared/spillover_controls',
               sprint: @sprint,
               project: @project,
               display_style: 'section',
               css_class: 'sprint-show-spillover' %>
  </div>
</div>

<div class="drag-container">
  <!-- Sprint Issues Table -->
  <div class="drag-table">
    <h3>âœ… Issues in this Sprint</h3>
    <table class="list issues-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Subject</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Story Points</th>
          <th>Tags</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="sprint-issues" class="sprint-droppable-area" data-sprint="<%= @sprint.id %>">
        <% if @sprint.issues.any? %>
          <% @sprint.issues.each do |issue| %>
            <tr class="sprint-card" draggable="true" data-id="<%= issue.id %>">
              <td><strong><%= link_to issue.id, issue_path(issue) %></strong></td>
              <td><%= issue.subject %></td>
              <td><%= issue.status.name %></td>
              <td><%= issue.assigned_to&.name || 'Unassigned' %></td>
              <td><%= issue.story_points || 0 %></td>
              <td>
                <% if issue.tags.any? %>
                  <% issue.tags.each_with_index do |tag, i| %>
                    <span class="issue-tag color-<%= (i % 5) + 1 %>"><%= tag %></span>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="action-cell">
                <%= link_to 'Remove', update_sprint_project_agile_board_path(@project, id: issue.id, sprint_id: ''),
                            class: 'icon icon-del remove-sprint-link', title: 'Remove from Sprint' %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr class="droppable-empty"><td colspan="6"><em>Drop issues here to assign</em></td></tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Unassigned Issues Table -->
  <div class="drag-table">
    <h3>ðŸ“¦ Unassigned Issues</h3>
    <table class="list issues-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Subject</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Story Points</th>
          <th>Tags</th>
        </tr>
      </thead>
      <tbody id="unassigned-issues" class="sprint-droppable-area" data-sprint="">
        <% unassigned = @project.issues.where(sprint_id: nil).where(status_id: IssueStatus.where(is_closed: false)) %>
        <% if unassigned.any? %>
          <% unassigned.each do |issue| %>
            <tr class="sprint-card" draggable="true" data-id="<%= issue.id %>">
              <td><strong><%= link_to issue.id, issue_path(issue) %></strong></td>
              <td><%= issue.subject %></td>
              <td><%= issue.status.name %></td>
              <td><%= issue.assigned_to&.name || 'Unassigned' %></td>
              <td><%= issue.story_points || 0 %></td>
              <td>
                <% issue.tags.each_with_index do |tag, i| %>
                  <span class="issue-tag color-<%= (i % 5) + 1 %>"><%= tag %></span>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr class="droppable-empty"><td colspan="5"><em>Drop issues here to unassign</em></td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<br/>
<p><%= link_to 'â¬… Back to Sprint List', project_sprints_path(@project), class: 'icon icon-back' %></p>

<%= render 'shared/spillover_modal',
           sprint: @sprint,
           project: @project,
           modal_id: 'sprint-spillover-modal',
           form_id: 'sprint-selective-spillover-form',
           select_all_id: 'select_all_incomplete_sprint',
           checkbox_class: 'incomplete-task-checkbox-sprint',
           close_function: 'hideSprintSpilloverModal',
           toggle_function: 'toggleAllIncompleteSprintShow',
           submit_button_id: 'sprint-move-selected-btn' %>

<%= javascript_include_tag 'agile_board', plugin: 'redmine_sprint_board_pro' %>
<%= javascript_include_tag 'spillover', plugin: 'redmine_sprint_board_pro' %>