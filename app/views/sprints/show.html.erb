<%= stylesheet_link_tag 'agile_board', plugin: 'redmine_sprint_board_pro' %>
<%= stylesheet_link_tag 'tags', plugin: 'redmine_sprint_board_pro' %>

<% content_for :header_tags do %>
  <meta name="csrf-token" content="<%= form_authenticity_token %>">
  <script>window.projectIdentifier = "<%= @project.identifier %>"</script>
<% end %>

<h2><%= @sprint.name %> <span style="font-size: 0.8em; color: #888;">(<%= l(:field_sprint) %>)</span></h2>

<div class="sprint-summary box">
  <p><strong>ðŸ“… <%= l(:field_start_date) %>:</strong> <%= format_date(@sprint.start_date) %></p>
  <p><strong>ðŸ“… <%= l(:field_sprint_end_date) %>:</strong> <%= format_date(@sprint.end_date) %></p>
  <p><strong>ðŸ“ˆ <%= l(:label_dashboard_sprint_total_points) %>:</strong> <%= @sprint.total_points %></p>
  <p><strong>âœ… <%= l(:label_dashboard_sprint_completed_points) %>:</strong> <%= @sprint.completed_points %></p>
  <p><strong>ðŸ“Š <%= l(:label_dashboard_sprint_progress) %>:</strong> <%= sprint_progress_percent(@sprint) %>%</p>
  <p><%= link_to 'ðŸ“Š'+l(:label_dashboard_sprint), dashboard_project_sprint_path(@project,@sprint) %></p>
</div>

<div class="drag-container">
  <!-- Sprint Issues Table -->
  <div class="drag-table">
    <h3>âœ… <%= l(:label_sprint_issues) %></h3>
    <table class="list issues-table">
      <thead>
        <tr>
          <th>#</th>
          <th><%= l(:field_subject) %></th>
          <th><%= l(:field_status) %></th>
          <th><%= l(:field_assigned_to) %></th>
          <th><%= l(:field_story_points) %></th>
          <th><%= l(:label_sprint_tags) %></th>
          <th></th>
        </tr>
      </thead>
      <tbody id="sprint-issues" class="sprint-droppable-area" data-sprint="<%= @sprint.id %>">
        <% if @sprint.issues.any? %>
          <% @sprint.issues.each do |issue| %>
            <tr class="sprint-card" draggable="true" data-id="<%= issue.id %>">
              <td><strong><%= link_to issue.id, issue_path(issue) %></strong></td>
              <td><%= issue.subject %></td>
              <td><%= issue.status.name %></td>
              <td><%= issue.assigned_to&.name || 'Unassigned' %></td>
              <td><%= issue.story_points || 0 %></td>
              <td>
                <% if issue.tags.any? %>
                  <% issue.tags.each_with_index do |tag, i| %>
                    <span class="issue-tag color-<%= (i % 5) + 1 %>"><%= tag %></span>
                  <% end %>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="action-cell">
                <%= link_to sprite_icon('del', l(:button_delete)), update_sprint_project_agile_board_path(@project, id: issue.id, sprint_id: ''),
                            class: 'icon icon-del remove-sprint-link', title: l(:label_remove_from_sprint) %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr class="droppable-empty"><td colspan="6"><em><%= l(:text_sprint_drop_issues) %></em></td></tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Unassigned Issues Table -->
  <div class="drag-table">
    <h3>ðŸ“¦ <%= l(:text_sprint_unassigned_issues) %></h3>
    <table class="list issues-table">
      <thead>
        <tr>
          <th>#</th>
          <th><%= l(:field_subject) %></th>
          <th><%= l(:field_status) %></th>
          <th><%= l(:field_assigned_to) %></th>
          <th><%= l(:field_story_points) %></th>
          <th><%= l(:label_sprint_tags) %></th>
        </tr>
      </thead>
      <tbody id="unassigned-issues" class="sprint-droppable-area" data-sprint="">
        <% unassigned = @project.issues.where(sprint_id: nil).where(status_id: IssueStatus.where(is_closed: false)) %>
        <% if unassigned.any? %>
          <% unassigned.each do |issue| %>
            <tr class="sprint-card" draggable="true" data-id="<%= issue.id %>">
              <td><strong><%= link_to issue.id, issue_path(issue) %></strong></td>
              <td><%= issue.subject %></td>
              <td><%= issue.status.name %></td>
              <td><%= issue.assigned_to&.name || 'Unassigned' %></td>
              <td><%= issue.story_points || 0 %></td>
              <td>
                <% issue.tags.each_with_index do |tag, i| %>
                  <span class="issue-tag color-<%= (i % 5) + 1 %>"><%= tag %></span>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr class="droppable-empty"><td colspan="5"><em><%= l(:text_sprint_drop_issues) %></em></td></tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<br/>
<p><%= link_to 'â¬…'+l(:label_back_to_sprint_list), project_sprints_path(@project), class: 'icon icon-back' %></p>

<%= javascript_include_tag 'agile_board', plugin: 'redmine_sprint_board_pro' %>